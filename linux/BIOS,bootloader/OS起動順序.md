## OS起動

起動順序
* BIOS/UEFI => ブートローダー => カーネル => init/systemd

### BIOS/UEFI

* BIOS
  * マザーボードの不揮発性メモリに組み込まれているプログラム
  * 決められた優先順位に従ってブートメディアを指定
  * ブートメディアの先頭セクタにあるブートローダーをロード
  * 16bitモードでしか動作しない => 1MBのメモリ空間にしかアクセスできない
    * システムの機能強化が困難
    * マザーボード毎にフォームウェアをアセンブラで開発
* UEFI (Unified Extensible Firmware Interface)
  * BIOSの後継
  * 起動／再開時間短縮
  * 2TB以上の大容量ドライブ使用可能
  * OS読み込み前に信頼されていないコードを実行不可にするセキュアブート対応
  * 旧BIOSとの互換性のために残されているCSM(Compatibility Support Module)は削除の方向

## MBR, GPTとは

* 関連用語
  * ブートセクタ
    * HDD, FDDなどのディスクセクタの一種
    * ブートプログラムのコードなどを格納
* MBR(Master boot record)
  * CHS(Cylinder head sector)でディスク内の位置を示す
    * 同心円状に複数のトラックを持つ記憶媒体上の絶対位置を示す
      * 例) FDの表、2トラック目、3セクタ: "H=0, C=1, S=2"
      * 初期のHDDもこの方式でアクセスを行っていた
        * 容量増大に従い、ディスクの内側と外側のトラックでセクタ数が異なるなどの問題が生じた
          * CHSでアドレスを管理する意味が薄れ、LBAが主流に
  * パーティションのある記憶媒体の第一セクタ
    * サイズは512バイト
    * BIOSは単純に最初にここを読みに行く
      * ウイルスに狙われる場合がある
    * 構成
      * 参考) https://ja.wikipedia.org/wiki/%E3%83%9E%E3%82%B9%E3%82%BF%E3%83%BC%E3%83%96%E3%83%BC%E3%83%88%E3%83%AC%E3%82%B3%E3%83%BC%E3%83%89
      * 最初の446バイト: ブートストラップローダ
        * 自身をメモリ上へコピーして起動
        * パーティションテーブルを4つのテーブルエントリの先頭から検査し、起動フラグが立っているパーティションを探す
        * 起動フラグが立っているパーティションが見つかったら、当該領域の先頭位置をパーティションテーブルから取得
        * BIOSにその位置を示してメモリにロードしてもらい、IPLに制御を渡す
  * 古いパーティション形式
  * HDDの上限が2TB
  * パーティション数最大4個
    * 512バイト制限のため
  * BIOSで使用される
* GPT(Global Unique Identifier Partition Table)
  * LBA(Logical Block Addressing)でディスク内の位置を示す
    * ディスクの全セクタに一意の通し番号を付ける方法
  * 構成
    * LBA0: MBR
      * 互換性
      * MBRを前提としたディスクユーティリティでの事故防止
        * MBRがないために、何もないパーティションと判断されないため
        * ディスク全体が1つのパーティションであるとの情報が記述される
    * LBA1: 第一GPTヘッダー
      * パーティションテーブルヘッダー
      * ユーザーが使用可能なディスクの範囲を定義
      * パーティションテーブル内のパーティションエントリ数とサイズを定義
      * ヘッダー自身のサイズと位置(常にLBA1)と第二GPTヘッダーのサイズと位置(常にディスクの最後のセクター)を保持
      * CRC32チェックサムを保持
        * 不整合発生時は第二GPTを第一GPTにコピー
    * LBA2-33: パーティションエントリ
      * 最初の16バイト: パーティションの種類を表すGUID
      * 次の16バイト: パーティション固有のGUID
      * 次の8バイト: バーティションの最初のLBA
      * 最後の8バイト: 最後のLBA
  * 新しいパーティション形式
  * HDDの上限が8.5ZB（実質制限なし）
  * 64bit必須
  * EFIが持つ拡張機能を使用し、ブートローダーを実現
    * EFI partitionは1ディスクに1つ
  * UEFIで使用される
  * fdiskでは扱えない