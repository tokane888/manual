# ラズパイルーター化手順

* 注意
  * 下記手順で2GHzのwifiを飛ばせることはRaspberry Pi 3B+(buster)で確認済み
  * ラズパイルーターは低速(設定が微妙なのもあるが)
    * buffaloのルーター使用時: 90Mbps
    * ラズパイルーター使用時: 40Mbps
    * chromeでページを開く際に2秒程度の待ち時間が生じる
    * LEDEというルーター専用OSがあるという情報もある。こちらなら実用的な速度が出るかも
* 参考
  * https://www.instructables.com/id/Use-Raspberry-Pi-3-As-Router/
    * WAN側はpppoeではない
  * https://qiita.com/tanaka4410/items/a524cef301f8f7e893c3
    * dnsmasq使っていない
  * https://qiita.com/tanaka4410/items/a524cef301f8f7e893c3
  * https://seasky.blue/weblog/index.php?e=2146
  * http://junyelee.blogspot.com/2019/10/setting-up-raspberry-pi-as-wireless.html
    * dnsmasq+pppoe
* 検証環境
  * raspberry pi 3B+
  * raspbian OS(buster)
* 前提
  * WAN側はpppoe接続
  * 2GHzのwifiのみ提供
    * 5GHz wifiも類似の設定で可能。後述
    * 2GHz, 5GHzの両方のwifiを同時に提供する場合、wifiドングルの購入が必要

## 手順

* プロバイダ側との接続を確立（プロバイダ.md参照）
* テザリングなどのネット接続可能なネットワークへ接続
* /etc/wpa_supplicant/wpa_supplicant.confのwifiアクセス設定削除
  * アクセスする側になってしまうことを防ぐため
    * TODO: もっとスマートな方法があれば追記
  * 下記で現在のwifiの状態を確認可能
    * iwconfig
      * Mode: masterであればOK
* apt install -y hostapd dnsmasq
* /etc/dhcpcd.conf末尾に下記記載
  ```
  denyinterfaces eth0               # ppp0とデフォルトゲートウェイが重複することを防ぐため
  interface wlan0
  static ip_address=192.168.11.1/24
  ```
* /etc/network/interfaces に下記の項目が記載されていることを確認
  ```
  auto dsl-provider
  iface dsl-provider inet ppp
  pre-up /bin/ip link set eth0 up
  provider dsl-provider
  ```
  * raspbian OSはjessie以降は/etc/dhcpcd.conf に固定IPを記載する仕様に変更
    * /etc/network/interfaces に固定IPを記載すると、OS起動時にdhcpcd serviceが起動失敗
* hostapd設定
  * /etc/hostapd/wlan0.conf に2ghz向け設定記載
    * ssid, wpa_passphraseは適宜変更
    ```
    interface=wlan0
    driver=nl80211
    country_code=JP
    ssid=pi_2ghz
    hw_mode=g
    channel=7
    wmm_enabled=0
    macaddr_acl=0
    auth_algs=1
    ignore_broadcast_ssid=0
    wpa=2
    wpa_passphrase=(pass)
    wpa_key_mgmt=WPA-PSK
    wpa_pairwise=TKIP
    rsn_pairwise=CCMP
    ```
  * 参考) 5GHz wifiを公開する場合、/etc/hostapd/wlan0.conf に5ghz向け設定記載
    * 2GHzと同時に提供する場合は、wifiドングルの購入が必要
    * ssid, wpa_passphraseは適宜変更
    ```
    interface=wlan0
    country_code=JP
    ssid=pi
    ieee80211ac=1
    hw_mode=a
    channel=7
    wmm_enabled=0
    macaddr_acl=0
    auth_algs=1
    ignore_broadcast_ssid=0
    wpa=2
    wpa_passphrase=(pass)
    wpa_key_mgmt=WPA-PSK
    wpa_pairwise=TKIP
    rsn_pairwise=CCMP
    ```
  * systemctl enable hostapd@wlan0
  * 参考) /etc/default/hostapd のDAEMON_CONFでhostapdの設定ファイルパスを指定する方法はdeprecated
    * 最新の方法は　/usr/share/doc/hostapd/README.Debian 参照
* dnsmasq設定
  * /etc/dnsmasq.conf に下記記載
    ```
    interface=wlan0             # Listen dns and dhcp request only from wlan0
    listen-address=192.168.11.1
    domain-needed
    bogus-priv
    dhcp-authoritative
    dhcp-range 192.168.11.2, 192.168.11.254, 24h
    ```
  * 下記で設定ファイルテスト
    * dnsmasq --test
* 無線LAN側のIP, host名を設定
  * /etc/hosts に下記追記
    * 192.168.11.1 rpi3
* IPv4のforward設定追加
  * /etc/sysctl.conf の下記コメントアウト
    * net.ipv4.ip_forward=1
  * iptables -t nat -A  POSTROUTING -o eth0 -j MASQUERADE
  * iptables-save > /etc/iptables.ipv4.nat
  * /etc/rc.local のexit 0直前に下記追記
    * iptables-restore < /etc/iptables.ipv4.nat